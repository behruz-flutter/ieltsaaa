<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Topik so'zlari — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1619;
    --panel:#10161a;
    --muted:#93a0aa;
    --text:#e6eef3;
    --accent:#7c3aed;
    --row-border: rgba(255,255,255,0.03);
    --green:#14b37d;
    --danger:#ef4444;
    --surface: #0c1316;
    --card: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#071015 0%, #071015 100%);color:var(--text);min-height:100vh;padding:28px}
  .container{max-width:1200px;margin:0 auto}
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
  h1{margin:0;font-size:24px}
  .breadcrumb{color:var(--muted);font-size:13px;margin-top:6px}
  .card{background:var(--panel);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .controls-row{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .left-controls{display:flex;gap:12px;align-items:center}
  .search{position:relative}
  .search input{padding:10px 14px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text);min-width:300px}
  .right-controls{display:flex;gap:12px;align-items:center}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent}
  .btn.primary{background:linear-gradient(90deg,var(--accent),#5b21b6);color:#fff;border:none}
  .btn.icon{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:999px}
  .table-wrap{overflow:auto;border-radius:10px;border:1px solid rgba(255,255,255,0.02);min-height:220px}
  table{width:100%;border-collapse:collapse;min-width:920px}
  thead tr{background:rgba(255,255,255,0.02)}
  th, td{padding:14px 12px;border-bottom:1px dashed rgba(255,255,255,0.02);font-size:14px;vertical-align:middle}
  th:first-child, td:first-child{width:48px}
  td.actions{width:64px;text-align:center}
  tr.row-item{background:transparent;cursor:grab}
  tr.row-item:active{cursor:grabbing}
  tr.row-item:hover{background:rgba(255,255,255,0.01)}
  tr.row-item.drag-over{outline:2px dashed rgba(124,58,237,0.6)}
  .checkbox{width:18px;height:18px;border-radius:4px;border:1px solid rgba(255,255,255,0.06);display:inline-block;position:relative;cursor:pointer}
  .checkbox.checked{background:var(--accent);border-color:var(--accent)}
  .badge{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px;background:rgba(20,179,125,0.12);color:var(--green);font-weight:700}
  .audio-btn{width:40px;height:40px;border-radius:999px;background:linear-gradient(90deg,var(--accent),#5b21b6);display:inline-flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;border:none}
  .wave{display:inline-block;height:12px;vertical-align:middle;margin-left:8px}
  .three-dots{cursor:pointer;color:var(--muted)}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px}
  .pagination{display:flex;align-items:center;gap:8px}
  .select-mini{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .popover{position:absolute;background:var(--panel);border-radius:8px;border:1px solid rgba(255,255,255,0.04);padding:10px;box-shadow:0 8px 24px rgba(2,6,23,0.6);z-index:40}
  .hidden{display:none}
  .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--panel);padding:16px;border-radius:12px;width:520px;border:1px solid rgba(255,255,255,0.03)}
  .form-row{display:flex;gap:8px;margin-top:8px}
  .form-row input{flex:1;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
  .small{font-size:13px;color:var(--muted)}
  /* density */
  .density-compact th, .density-compact td{padding:8px 8px}
  .density-comfort th, .density-comfort td{padding:18px 16px}
  /* waveform visual */
  .wave-canvas{display:inline-block;height:14px;width:90px;vertical-align:middle}
  .wave-canvas .bar{display:inline-block;width:4px;height:8px;background:linear-gradient(180deg,#9f7aea,#6d28d9);margin-right:2px;border-radius:2px;opacity:0.9;transform-origin:bottom;animation:wave 1s linear infinite}
  @keyframes wave{0%{transform:scaleY(0.3)}50%{transform:scaleY(1)}100%{transform:scaleY(0.3)}}
  /* responsive small */
  @media (max-width:900px){ .search input{min-width:160px} table{min-width:760px} }
  /* visual hint when external drag over table */
  .table-wrap.drop-active{box-shadow:0 0 0 4px rgba(124,58,237,0.08) inset}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div>
      <h1>Topik so'zlari <span class="small">(<span id="totalCount">0</span> so'z)</span></h1>
      <div class="breadcrumb small">Asosiy • Flash Card • Topik • So'zlari</div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <button class="btn" id="addBtn">＋ Qo'shish</button>
      <button class="btn ghost" id="exportAllBtn">Export</button>
    </div>
  </div>

  <div class="card">
    <div class="controls-row">
      <div class="left-controls">
        <div class="search">
          <input id="searchInput" placeholder="Search..." aria-label="Search"/>
        </div>
        <div style="width:12px"></div>
        <div style="position:relative">
          <button class="btn" id="columnsBtn">Columns</button>
          <div class="popover hidden" id="columnsPop" style="right:0;top:36px">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-col="col-word" checked> So'z</label>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-col="col-translate" checked> Tarjimasi</label>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-col="col-status" checked> Holat</label>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-col="col-audio" checked> Audio</label>
          </div>
        </div>
      </div>

      <div class="right-controls">
        <button class="btn" id="densityBtn">Density</button>
        <button class="btn" id="importBtn">Import</button>
        <button class="btn primary" id="downloadSelectedBtn">Download Selected</button>
      </div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table id="mainTable" class="density-comfort" role="table" aria-label="Words table">
        <thead>
          <tr>
            <th><span class="checkbox" id="selectAll" title="Select all"></span></th>
            <th class="col-word">So'z</th>
            <th class="col-translate">Tarjimasi</th>
            <th class="col-status">Holat</th>
            <th class="col-audio">Audio</th>
            <th>⋯</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- rows injected by JS -->
        </tbody>
      </table>
    </div>

    <div class="footer">
      <div>
        <span class="small">Rows per page:</span>
        <select id="rowsPerPage" class="select-mini" aria-label="Rows per page">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </div>

      <div class="pagination">
        <div class="small" id="pageInfo">0–0 of 0</div>
        <button class="btn" id="prevPage">‹</button>
        <button class="btn" id="nextPage">›</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="modalRoot" class="hidden"></div>

<!-- Import hidden file input -->
<input type="file" id="importFile" accept=".json,.csv" style="display:none">

<script>
/* Dashboard JS
- Fixed modal autofocusing so Add button lets you input immediately
- External drop adds new word (word and translate heuristics)
- Row drag & drop reorder fully working (move up/down including top)
- All other original behaviors preserved
*/

// ---------- Helpers ----------
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const STORAGE_KEY = 'topic_words_v1';
function nowISO(){ return (new Date()).toISOString(); }

// ---------- Sample data ----------
const SAMPLE = [
  {id:1, word:'Hot', translate:'Issiq', status:'Faol', created:nowISO()},
  {id:2, word:'Cold', translate:'Sovuq', status:'Faol', created:nowISO()},
  {id:3, word:'Sunny', translate:'Quyoshli', status:'Faol', created:nowISO()},
  {id:4, word:'Rainy', translate:'Yom\'irli', status:'Faol', created:nowISO()},
  {id:5, word:'Cloudy', translate:'Bulutli', status:'Faol', created:nowISO()},
  {id:6, word:'Snowy', translate:'Qorli', status:'Faol', created:nowISO()},
  {id:7, word:'Windy', translate:'Shamolli', status:'Faol', created:nowISO()},
  {id:8, word:'Foggy', translate:'Tumanli', status:'Faol', created:nowISO()},
  {id:9, word:'Stormy', translate:'Bajanli', status:'Faol', created:nowISO()},
  {id:10, word:'Humid', translate:'Nam', status:'Faol', created:nowISO()}
];

// ---------- State ----------
let state = {
  items: [],
  filter: '',
  page: 1,
  perPage: 10,
  selected: new Set(),
  density: 'comfort',
  columns: { 'col-word': true, 'col-translate': true, 'col-status': true, 'col-audio': true }
};

// ---------- Persistence ----------
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){ state.items = SAMPLE.slice(); saveState(); return; }
    const parsed = JSON.parse(raw);
    state.items = parsed.items || SAMPLE.slice();
  }catch(e){
    state.items = SAMPLE.slice();
    console.error(e);
  }
}
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({ items: state.items }));
}

// ---------- Drag state ----------
let dragSrcId = null;

// ---------- Rendering ----------
const tableBody = qs('#tableBody');
const totalCountEl = qs('#totalCount');
const pageInfo = qs('#pageInfo');
const tableWrap = qs('#tableWrap');

function render(){
  const filtered = state.items.filter(it=>{
    const f = state.filter.trim().toLowerCase();
    if(!f) return true;
    return (it.word||'').toLowerCase().includes(f) || (it.translate||'').toLowerCase().includes(f);
  });

  const total = filtered.length;
  const perPage = state.perPage;
  const totalPages = Math.max(1, Math.ceil(total / perPage));
  state.page = Math.min(state.page, totalPages);
  const startIndex = (state.page -1) * perPage;
  const pageItems = filtered.slice(startIndex, startIndex + perPage);

  tableBody.innerHTML = '';
  pageItems.forEach(it=>{
    const tr = document.createElement('tr');
    tr.className = 'row-item';
    tr.dataset.id = it.id;
    tr.draggable = true;

    // drag handlers (reorder)
    tr.addEventListener('dragstart', onRowDragStart);
    tr.addEventListener('dragover', onRowDragOver);
    tr.addEventListener('dragleave', onRowDragLeave);
    tr.addEventListener('drop', onRowDrop);
    tr.addEventListener('dragend', onRowDragEnd);

    // checkbox
    const tdCheck = document.createElement('td');
    const cb = document.createElement('span');
    cb.className = 'checkbox ' + (state.selected.has(it.id) ? 'checked' : '');
    cb.title = 'Select';
    cb.onclick = () => {
      if(state.selected.has(it.id)) state.selected.delete(it.id); else state.selected.add(it.id);
      render();
    };
    tdCheck.appendChild(cb);
    tr.appendChild(tdCheck);

    // word
    const tdWord = document.createElement('td');
    tdWord.className = 'col-word';
    tdWord.textContent = it.word;
    tr.appendChild(tdWord);

    // translate
    const tdTrans = document.createElement('td');
    tdTrans.className = 'col-translate';
    tdTrans.textContent = it.translate;
    tr.appendChild(tdTrans);

    // status
    const tdStatus = document.createElement('td');
    tdStatus.className = 'col-status';
    const span = document.createElement('span');
    span.className = 'badge';
    span.textContent = it.status || 'Faol';
    tdStatus.appendChild(span);
    tr.appendChild(tdStatus);

    // audio
    const tdAudio = document.createElement('td');
    tdAudio.className = 'col-audio';
    const audioBtn = document.createElement('button');
    audioBtn.className = 'audio-btn';
    audioBtn.title = 'Play audio';
    audioBtn.innerHTML = '&#9658;';
    audioBtn.onclick = ()=> playWord(it.word);
    tdAudio.appendChild(audioBtn);
    tdAudio.appendChild(createWaveElement());
    tr.appendChild(tdAudio);

    // actions
    const tdAct = document.createElement('td');
    tdAct.className = 'actions';
    const menu = document.createElement('span');
    menu.className = 'three-dots';
    menu.textContent = '⋮';
    menu.onclick = (e)=>{
      showRowMenu(e.currentTarget, it);
    };
    tdAct.appendChild(menu);
    tr.appendChild(tdAct);

    tableBody.appendChild(tr);
  });

  totalCountEl.textContent = state.items.length;
  const first = Math.min(state.items.length, startIndex + 1);
  const last = Math.min(state.items.length, startIndex + pageItems.length);
  pageInfo.textContent = `${first}–${last} of ${state.items.length}`;

  // columns
  Object.keys(state.columns).forEach(c=>{
    qsa('.' + c).forEach(el=>{
      el.style.display = state.columns[c] ? '' : 'none';
    });
  });

  // density
  const table = qs('#mainTable');
  table.classList.remove('density-compact','density-comfort');
  table.classList.add(state.density === 'compact' ? 'density-compact' : 'density-comfort');

  // select all visual
  const selectAll = qs('#selectAll');
  const allVisibleIds = filtered.slice(startIndex, startIndex + perPage).map(i=>i.id);
  const allSelected = allVisibleIds.length > 0 && allVisibleIds.every(id => state.selected.has(id));
  selectAll.classList.toggle('checked', allSelected);
}

// waveform visual
function createWaveElement(){
  const wrapper = document.createElement('span');
  wrapper.className = 'wave-canvas';
  for(let i=0;i<12;i++){
    const bar = document.createElement('span');
    bar.className = 'bar';
    bar.style.height = (6 + Math.round(Math.random()*18)) + 'px';
    bar.style.animationDelay = (Math.random()*0.6)+'s';
    wrapper.appendChild(bar);
  }
  return wrapper;
}

// ---------- Row menu ----------
function showRowMenu(anchor, item){
  qsa('.row-popover').forEach(e=>e.remove());
  const pop = document.createElement('div');
  pop.className = 'popover row-popover';
  pop.style.minWidth = '140px';
  pop.style.left = (anchor.getBoundingClientRect().left + window.scrollX - 150) + 'px';
  pop.style.top = (anchor.getBoundingClientRect().bottom + window.scrollY + 6) + 'px';
  pop.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      <button class="btn" id="editRowBtn">Edit</button>
      <button class="btn" id="deleteRowBtn" style="color:${getComputedStyle(document.documentElement).getPropertyValue('--danger')||'#ef4444'}">Delete</button>
    </div>
  `;
  document.body.appendChild(pop);

  pop.querySelector('#editRowBtn').onclick = ()=>{
    pop.remove(); openModal('edit', item);
  };
  pop.querySelector('#deleteRowBtn').onclick = ()=>{
    pop.remove();
    if(confirm('O\'chirishni tasdiqlaysizmi?')) { state.items = state.items.filter(x=>x.id !== item.id); state.selected.delete(item.id); saveState(); render(); }
  };

  setTimeout(()=>{ window.addEventListener('click', onDocClick); });
  function onDocClick(e){
    if(!pop.contains(e.target)) { pop.remove(); window.removeEventListener('click', onDocClick); }
  }
}

// ---------- Speech ----------
function playWord(text){
  if(!text) return;
  const synth = window.speechSynthesis;
  if(!synth) { alert('Audio not supported'); return; }
  const utter = new SpeechSynthesisUtterance(text);
  const voices = synth.getVoices();
  const enVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('en')) || voices[0];
  if(enVoice) utter.voice = enVoice;
  synth.cancel();
  synth.speak(utter);
}

// ---------- Modal ----------
const modalRoot = qs('#modalRoot');
function openModal(mode, item){
  modalRoot.innerHTML = '';
  modalRoot.classList.remove('hidden');
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">${mode==='add' ? 'So\'z qo\'shish' : 'So\'zni tahrirlash'}</div>
      <div><button class="btn" id="closeModalBtn">✕</button></div>
    </div>
    <div style="margin-top:10px" class="small">So'z va tarjimasini kiriting</div>
    <div class="form-row" style="margin-top:12px">
      <input id="modalWord" placeholder="So'z (EN)"/>
      <input id="modalTrans" placeholder="Tarjimasi (UZ)"/>
    </div>
    <div class="form-row">
      <select id="modalStatus">
        <option>Faol</option>
        <option>Faolsiz</option>
      </select>
      <input id="modalId" style="display:none"/>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" id="cancelModal">Bekor</button>
      <button class="btn primary" id="saveModal">Saqlash</button>
    </div>
  `;
  backdrop.appendChild(modal);
  modalRoot.appendChild(backdrop);

  // populate
  if(mode==='edit' && item){
    modal.querySelector('#modalWord').value = item.word;
    modal.querySelector('#modalTrans').value = item.translate;
    modal.querySelector('#modalStatus').value = item.status || 'Faol';
    modal.querySelector('#modalId').value = item.id;
  }

  // autofocus the word input so Add immediately allows typing
  setTimeout(()=>{ const w = modal.querySelector('#modalWord'); if(w){ w.focus(); w.select(); } }, 50);

  modal.querySelector('#closeModalBtn').onclick = ()=> closeModal();
  modal.querySelector('#cancelModal').onclick = ()=> closeModal();
  modal.querySelector('#saveModal').onclick = ()=> {
    const w = modal.querySelector('#modalWord').value.trim();
    const t = modal.querySelector('#modalTrans').value.trim();
    const s = modal.querySelector('#modalStatus').value;
    if(!w) { alert('So\'z kiriting'); return; }
    const idVal = modal.querySelector('#modalId').value;
    if(idVal){
      const id = Number(idVal);
      const idx = state.items.findIndex(x=>x.id===id);
      if(idx>=0){ state.items[idx].word = w; state.items[idx].translate = t; state.items[idx].status = s; saveState(); render(); }
    } else {
      const id = (state.items.reduce((m,x)=>Math.max(m,x.id||0),0) || 0) + 1;
      state.items.unshift({ id, word: w, translate: t, status: s, created: nowISO() });
      saveState(); render();
    }
    closeModal();
  };
}
function closeModal(){ modalRoot.innerHTML = ''; modalRoot.classList.add('hidden'); }

// ---------- Selection & pagination ----------
qs('#selectAll').onclick = ()=>{
  const filtered = state.items.filter(it=>{
    const f = state.filter.trim().toLowerCase();
    if(!f) return true;
    return (it.word||'').toLowerCase().includes(f) || (it.translate||'').toLowerCase().includes(f);
  });
  const startIndex = (state.page-1) * state.perPage;
  const visible = filtered.slice(startIndex, startIndex + state.perPage).map(i=>i.id);
  const allSelected = visible.every(id => state.selected.has(id));
  if(allSelected){
    visible.forEach(id => state.selected.delete(id));
  } else {
    visible.forEach(id => state.selected.add(id));
  }
  render();
};

qs('#prevPage').onclick = ()=>{ if(state.page > 1) { state.page--; render(); } };
qs('#nextPage').onclick = ()=>{ const filteredCount = state.items.filter(it=>{ const f = state.filter.trim().toLowerCase(); if(!f) return true; return (it.word||'').toLowerCase().includes(f) || (it.translate||'').toLowerCase().includes(f); }).length; const totalPages = Math.max(1, Math.ceil(filteredCount / state.perPage)); if(state.page < totalPages){ state.page++; render(); } };
qs('#rowsPerPage').onchange = (e) => { state.perPage = Number(e.target.value); state.page = 1; render(); };

// ---------- Search ----------
qs('#searchInput').addEventListener('input', (e)=>{
  state.filter = e.target.value;
  state.page = 1;
  render();
});

// ---------- Add/Edit -->
qs('#addBtn').onclick = ()=> openModal('add');

// ---------- Import/Export ----------
qs('#importBtn').onclick = ()=> qs('#importFile').click();
qs('#importFile').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const text = ev.target.result;
    try{
      if(f.name.toLowerCase().endsWith('.json')){
        const arr = JSON.parse(text);
        if(Array.isArray(arr)){
          arr.forEach((r, idx)=>{
            const id = (state.items.reduce((m,x)=>Math.max(m,x.id||0),0) || 0) + idx + 1;
            state.items.push({ id, word: r.word||r.WORD||r.word_en||'', translate: r.translate||r.tarjima||r.translate_uz||'', status: r.status||'Faol', created: nowISO()});
          });
          saveState(); render(); alert('JSON import qilindi');
        } else {
          alert('JSON array bo\'lishi kerak');
        }
      } else {
        const lines = text.split(/\r?\n/).filter(Boolean);
        const header = lines.shift().split(',');
        lines.forEach(line=>{
          const cols = line.split(',');
          const row = {};
          header.forEach((h,i)=> row[h.trim().toLowerCase()] = (cols[i]||'').trim());
          const id = (state.items.reduce((m,x)=>Math.max(m,x.id||0),0) || 0) + 1;
          state.items.push({ id, word: row.word||row.wod||'', translate: row.translate||row.tarjima||'', status: row.status||'Faol', created: nowISO() });
        });
        saveState(); render(); alert('CSV import qilindi');
      }
    }catch(err){ console.error(err); alert('Importda xato: ' + err.message); }
  };
  reader.readAsText(f);
  e.target.value = '';
};

function downloadJSON(arr, filename='export.json'){
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function downloadCSV(arr, filename='export.csv'){
  if(!arr.length) { alert('No rows'); return; }
  const headers = Object.keys(arr[0]);
  const rows = [headers.join(',')].concat(arr.map(r => headers.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(',')));
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

qs('#downloadSelectedBtn').onclick = ()=>{
  const sel = state.items.filter(it => state.selected.has(it.id));
  if(!sel.length){ alert('Iltimos, satrlarni tanlang'); return; }
  const type = prompt('Format: json yoki csv ?', 'json');
  if(!type) return;
  if(type.toLowerCase().startsWith('c')) downloadCSV(sel, 'selected.csv'); else downloadJSON(sel, 'selected.json');
};

qs('#exportAllBtn').onclick = ()=>{
  const type = prompt('Export format: json yoki csv ?', 'json');
  if(!type) return;
  if(type.toLowerCase().startsWith('c')) downloadCSV(state.items, 'all_words.csv'); else downloadJSON(state.items, 'all_words.json');
};

// ---------- Columns popover ----------
qs('#columnsBtn').onclick = (e) => { qs('#columnsPop').classList.toggle('hidden'); };
qsa('#columnsPop input[type="checkbox"]').forEach(ch => { ch.onchange = (ev) => { const col = ev.target.dataset.col; state.columns[col] = ev.target.checked; render(); }; });

// ---------- density switch ----------
qs('#densityBtn').onclick = ()=>{ state.density = state.density === 'comfort' ? 'compact' : 'comfort'; render(); };

// ---------- Drag & Drop handlers for rows (improved) ----------
function onRowDragStart(e){
  const tr = e.currentTarget;
  dragSrcId = Number(tr.dataset.id);
  e.dataTransfer.effectAllowed = 'move';
  try{ e.dataTransfer.setData('application/x-item', String(dragSrcId)); }
  catch(err){}
  // also set text/plain for external detection (for some browsers)
  try{ e.dataTransfer.setData('text/plain', JSON.stringify({ type: 'row', id: dragSrcId })); }catch(err){}
  tr.style.opacity = '0.4';
}
function onRowDragOver(e){
  // allow drop and visually mark
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.classList.add('drag-over');
}
function onRowDragLeave(e){
  e.currentTarget.classList.remove('drag-over');
}
function onRowDrop(e){
  e.preventDefault();
  const tr = e.currentTarget;
  tr.classList.remove('drag-over');

  // first try internal data
  let srcId = null;
  try{
    const data = e.dataTransfer.getData('application/x-item');
    if(data) srcId = Number(data);
  }catch(err){ srcId = null; }

  if(!srcId){
    // fallback to JSON text
    try{
      const txt = e.dataTransfer.getData('text/plain');
      const parsed = JSON.parse(txt || '');
      if(parsed && parsed.type === 'row' && parsed.id) srcId = Number(parsed.id);
    }catch(err){}
  }

  if(srcId){
    const targetId = Number(tr.dataset.id);
    // compute indices
    const idxSrc = state.items.findIndex(i=>i.id === srcId);
    const idxT = state.items.findIndex(i=>i.id === targetId);
    if(idxSrc >=0 && idxT >=0){
      // remove source
      const [item] = state.items.splice(idxSrc, 1);
      // if source was before target, after removal the target index decreases by 1
      const insertAt = idxSrc < idxT ? idxT : idxT;
      state.items.splice(insertAt, 0, item);
      saveState();
      render();
    }
    dragSrcId = null;
    return;
  }

  // if not internal, check for external text drop (text/plain or text/html)
  let raw = '';
  try{ raw = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html') || ''; }catch(err){ raw = ''; }
  const txt = raw && typeof raw === 'string' ? raw.trim() : '';
  if(txt){
    const parsedText = parseDroppedText(txt);
    insertNewWordAt(parsedText.word, parsedText.translate, Number(tr.dataset.id));
  }
}
function onRowDragEnd(e){
  e.currentTarget.style.opacity = '';
  dragSrcId = null;
  qsa('tr.row-item').forEach(r=> r.classList.remove('drag-over'));
}

// ---------- External drop on tableWrap ----------
function onTableDragOver(e){ e.preventDefault(); tableWrap.classList.add('drop-active'); e.dataTransfer.dropEffect = 'copy'; }
function onTableDragLeave(e){ tableWrap.classList.remove('drop-active'); }
function onTableDrop(e){ e.preventDefault(); tableWrap.classList.remove('drop-active'); let raw = ''; try{ raw = e.dataTransfer.getData('text/plain') || e.dataTransfer.getData('text/html') || ''; }catch(err){ raw = ''; } const txt = raw && typeof raw === 'string' ? raw.trim() : ''; if(!txt) return; const el = document.elementFromPoint(e.clientX, e.clientY); const tr = el ? el.closest('tr.row-item') : null; const parsedText = parseDroppedText(txt); if(tr){ insertNewWordAt(parsedText.word, parsedText.translate, Number(tr.dataset.id)); } else { insertNewWordAt(parsedText.word, parsedText.translate, null); } }

tableWrap.addEventListener('dragover', onTableDragOver);
tableWrap.addEventListener('dragleave', onTableDragLeave);
tableWrap.addEventListener('drop', onTableDrop);

// ---------- Parse dropped text ----------
function parseDroppedText(txt){
  // if HTML fragment (from selection) contains element text, extract visible text
  if(txt.startsWith('<') && txt.includes('>')){
    // naive strip tags
    const div = document.createElement('div');
    div.innerHTML = txt;
    txt = div.textContent || div.innerText || txt;
  }
  // common separators
  const separators = [' - ', ' — ', ' – ', ':', '|', '\t', ',', '\n'];
  for(const sep of separators){
    if(txt.includes(sep)){
      const parts = txt.split(sep);
      if(parts.length >= 2){
        return { word: parts[0].trim(), translate: parts.slice(1).join(sep).trim() };
      }
    }
  }
  // fallback: if contains multiple words, take first word as word, rest as translate
  const tokens = txt.split(/\s+/).filter(Boolean);
  if(tokens.length === 1) return { word: txt.trim(), translate: '' };
  const first = tokens.shift();
  return { word: first.trim(), translate: tokens.join(' ').trim() };
}

// ---------- Insert new word ----------
function insertNewWordAt(word, translate, beforeId){
  const id = (state.items.reduce((m,x)=>Math.max(m,x.id||0),0) || 0) + 1;
  const newItem = { id, word: word || '', translate: translate || '', status: 'Faol', created: nowISO() };
  if(beforeId){
    const idx = state.items.findIndex(i=>i.id === beforeId);
    if(idx >= 0) state.items.splice(idx, 0, newItem);
    else state.items.unshift(newItem);
  } else {
    state.items.unshift(newItem);
  }
  saveState();
  render();
  showTempToast(`So'z qo'shildi: ${newItem.word}`);
}

// small toast
const toast = document.createElement('div');
toast.style.position = 'fixed';
toast.style.right = '18px';
toast.style.bottom = '18px';
toast.style.background = 'rgba(11,17,22,0.95)';
toast.style.padding = '8px 12px';
toast.style.borderRadius = '8px';
toast.style.border = '1px solid rgba(255,255,255,0.04)';
toast.style.display = 'none';
document.body.appendChild(toast);
function showTempToast(msg, ms=1600){ toast.textContent = msg; toast.style.display = 'block'; setTimeout(()=>{ toast.style.display = 'none'; }, ms); }

// ---------- initialize & rest ----------
loadState();
render();

// close popovers on outside click
window.addEventListener('click', (e)=>{
  const pop = qs('#columnsPop');
  if(pop && !pop.classList.contains('hidden')){
    if(!qs('#columnsBtn').contains(e.target) && !pop.contains(e.target)) pop.classList.add('hidden');
  }
});

// keyboard shortcuts (N = new)
window.addEventListener('keydown', (e)=>{
  if(e.key === 'n' || e.key === 'N'){ openModal('add'); }
});

</script>
</body>
</html>




