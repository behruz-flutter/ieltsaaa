<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IELTS Speaking ‚Äî Auto-score (with PNG export)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ----------------- Theme variables ----------------- */
    :root{
      /* Dark default */
      --bg: #071634;
      --bg2: #0b1930;
      --panel: #0e1330;
      --text: #ffffff;
      --muted: #b9c6e8;
      --brand: #7c9cff;
      --mint: #5eead4;
      --stroke: rgba(124,156,255,.16);
      --chip: #0c1230;
      --ring: #203060;
      --btn-bg: linear-gradient(180deg,#152443,#0f1a36);
      --btn-ghost-bg: rgba(255,255,255,0.03);
      --card-radius: 14px;
      --control-pad: 12px;
      --gutter: 24px;            /* NEW: general spacing between containers */
      --section-gap: 20px;      /* gap above sections */
    }
    [data-theme="light"]{
      --bg: #ffffff;
      --bg2: #f6f8ff;
      --panel: #ffffff;
      --text: #0b1020;
      --muted: #505a7a;
      --brand: #2b59ff;
      --mint: #0fcf97;
      --stroke: rgba(30,50,150,.08);
      --chip: #eef2ff;
      --ring: #dfe6ff;
      --btn-bg: linear-gradient(180deg,#f3f6ff,#eef3ff);
      --btn-ghost-bg: rgba(11,16,32,0.03);
      --card-radius: 14px;
      --control-pad: 12px;
      --gutter: 24px;
      --section-gap: 20px;
    }

    /* ----------------- Base resets ----------------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 120% -10%, rgba(24,34,74,.06) 0%, transparent 55%),
        radial-gradient(800px 500px at -20% 20%, rgba(21,32,74,.04) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background-color .25s ease, color .18s ease;
      padding-bottom:32px;
    }

    /* main layout padding increased */
    .wrap{max-width:1200px;margin:0 auto;padding:28px}

    header{
      position:sticky; top:0; z-index:40;
      background: linear-gradient(180deg, rgba(11,16,32,.6), rgba(11,16,32,.45));
      backdrop-filter: saturate(115%) blur(6px);
      border-bottom:1px solid var(--stroke);
      padding:14px 0;
    }
    [data-theme="light"] header{
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.85));
    }

    .head{max-width:1200px;margin:0 auto;padding:8px 28px;display:flex;gap:16px;align-items:center}
    .logo{display:flex;gap:12px;align-items:center}
    .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--mint));box-shadow:0 0 0 6px rgba(124,156,255,.06)}
    h1{font-size:clamp(18px,2.6vw,22px);margin:0}
    .sub{font-size:13px;color:var(--muted)}
    .spacer{flex:1}

    /* Buttons (compact) */
    .btn{
      appearance:none;
      -webkit-appearance:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      justify-content:center;
      background:var(--btn-bg);
      color:var(--text);
      border:1px solid var(--stroke);
      padding:8px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:13px;
      line-height:1;
      cursor:pointer;
      min-height:38px;
      transition:transform .08s ease, opacity .08s ease, background .12s ease;
    }
    .btn:active{ transform:translateY(1px) }
    .btn.ghost{ background:var(--btn-ghost-bg); color:var(--text); }
    .btn.danger{ background:linear-gradient(180deg,#3a1420,#2a0e18); color:#fff }
    .btn.ok{ background:linear-gradient(180deg,#0b3b25,#07321b); color:#fff }

    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .label{font-size:13px;color:var(--muted)}
    .meter{height:10px;background:#06102a;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .timer{font-variant-numeric:tabular-nums;font-size:24px;font-weight:800}
    .pill{font-size:13px;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip); color:var(--text)}
    .section{border:1px solid var(--stroke);background:var(--panel);border-radius:var(--card-radius);margin-top:var(--section-gap)}
    .section .head{padding:14px 16px}
    .section .body{padding:14px 16px;border-top:1px solid var(--stroke)}
    .card{background:linear-gradient(180deg,var(--bg2),var(--panel));border:1px solid var(--stroke);border-radius:var(--card-radius);padding:18px}
    .muted{color:var(--muted);font-size:14px;margin:0}

    .qa{display:grid;gap:10px}
    .question{padding:10px 12px;border:1px solid var(--stroke);background:var(--chip);border-radius:12px;position:relative;font-size:15px}
    textarea{width:100%;min-height:90px;border-radius:12px;border:1px solid var(--stroke);background:var(--chip);color:var(--text);padding:10px;font-size:14px}

    .audio-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    audio{width:100%}
    canvas{width:100%;height:46px;background:var(--chip);border:1px solid var(--stroke);border-radius:10px}

    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:640px){ .cols{grid-template-columns:1fr} }

    .range{display:flex;align-items:center;gap:8px}
    .score-pill{font-weight:800;padding:8px 12px;border-radius:12px;background:linear-gradient(90deg,#0b1222,#1a2546);border:1px solid var(--stroke);display:inline-block}
    .crit{font-size:13px;color:var(--muted);display:block;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}

    /* Grid spacing increased with --gutter */
    .grid{display:grid;gap:var(--gutter);margin-top:18px;grid-template-columns:1fr}
    @media(min-width:1050px){ .grid{grid-template-columns:1.12fr .88fr} }

    /* part tabs */
    .tabs{display:flex;gap:12px;margin-top:16px}
    .tab-btn{
      padding:8px 12px;border-radius:12px;border:1px solid var(--stroke);background:var(--btn-ghost-bg);color:var(--text);font-weight:700;font-size:14px;cursor:pointer;
    }
    .tab-btn.active{
      background: linear-gradient(90deg,var(--brand),var(--mint));
      color: #fff; border-color: transparent; box-shadow: 0 8px 22px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }

    aside .pill{padding:6px 10px;font-size:13px}
    .status-muted{ font-size:13px; color:var(--muted) }

    /* accessibility - focus */
    :focus { outline: 3px solid var(--ring); outline-offset:3px; border-radius:10px; }

    /* subtle responsive tweaks */
    @media(max-width:1050px){
      .head{padding:8px 16px}
      .wrap{padding:18px}
      .card{padding:14px}
      .tabs{gap:10px}
    }
  </style>
</head>
<body>
  <header>
    <div class="head">
      <div class="logo" aria-label="Logo">
        <span class="dot" aria-hidden="true"></span>
        <div>
          <h1>IELTS Speaking ‚Äî Pro Test</h1>
          <div class="sub">Avto-baholash: Fluency / Lexical / Grammar / Pronunciation + PNG eksport</div>
        </div>
      </div>
      <div class="spacer"></div>
      <button id="btnTheme" class="btn ghost" title="Light/Dark">üåì Tema</button>
      <button id="btnPrint" class="btn ghost">üñ®Ô∏è Chop etish</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card" id="test" aria-live="polite">
        <h2>Test paneli</h2>

        <!-- PART TABS -->
        <div class="tabs" role="tablist" aria-label="Parts tabs">
          <button class="tab-btn active" data-target="p1" role="tab" aria-selected="true">Part 1</button>
          <button class="tab-btn" data-target="p2" role="tab" aria-selected="false">Part 2</button>
          <button class="tab-btn" data-target="p3" role="tab" aria-selected="false">Part 3</button>
        </div>

        <p class="muted" style="margin-top:10px">Mikrofonga ruxsat bering, keyin <b>Start</b> yoki har bir part uchun ‚è∫Ô∏è tugmasini bosing. Hotkeys: Space ‚Äî toggle record.</p>

        <div class="section" aria-hidden="false">
          <div class="head row">
            <div class="timer" id="globalTimer">00:00</div>
            <span class="pill" id="phasePill">Standby</span>
            <div class="spacer"></div>
            <button id="btnSetup" class="btn">üéôÔ∏è Mic test</button>
            <button id="btnStart" class="btn ok">‚ñ∂Ô∏è Start</button>
            <button id="btnStop" class="btn danger" disabled>‚èπÔ∏è Stop</button>
            <button id="btnReset" class="btn ghost">‚Ü∫ Reset</button>
          </div>
          <div class="body">
            <div class="row" style="align-items:flex-start">
              <div style="flex:1;min-width:260px">
                <div class="label">Ovoz darajasi</div>
                <div class="meter" style="margin-bottom:8px;"><div class="bar" id="levelBar" style="height:100%;width:0%;background:linear-gradient(90deg,var(--brand),var(--mint));"></div></div>
                <canvas id="liveWave" height="46" aria-hidden="true"></canvas>
              </div>
              <div style="min-width:260px">
                <div class="label">Rejim</div>
                <div class="list" style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                  <span class="pill" id="micStatus">Mic: unknown</span>
                  <span class="pill" id="recStatus">Rec: idle</span>
                </div>
                <div class="small" style="margin-top:10px">SpeechRecognition: <span id="srStatus">unsupported</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- P1 -->
        <div class="section" id="p1" aria-hidden="false" style="display:block">
          <div class="head row">
            <strong>Part 1 ‚Äî Introduction</strong>
            <span class="pill" id="p1Score">‚Äî</span>
            <div class="spacer"></div>
            <button class="btn" data-rec="p1">‚è∫Ô∏è P1 Start/Stop</button>
          </div>
          <div class="body">
            <div class="qa" id="p1Qs">Savollar...</div>
            <div class="audio-row">
              <audio id="p1Audio" controls></audio>
              <a id="p1Dl" class="btn ghost" download>‚¨áÔ∏è Yuklab olish</a>
              <canvas id="p1Wave" height="46" aria-hidden="true"></canvas>
            </div>
            <div class="crit" id="p1Crit"></div>
          </div>
        </div>

        <!-- P2 -->
        <div class="section" id="p2" aria-hidden="true" style="display:none">
          <div class="head row">
            <strong>Part 2 ‚Äî Long Turn</strong>
            <span class="pill" id="p2Score">‚Äî</span>
            <div class="spacer"></div>
            <button class="btn" data-rec="p2">‚è∫Ô∏è P2 Start/Stop</button>
          </div>
          <div class="body">
            <div class="question big prep" id="p2Card">Cue Card‚Ä¶</div>
            <textarea id="p2Notes" placeholder="Eslatmalar"></textarea>
            <div class="audio-row"><audio id="p2Audio" controls></audio><a id="p2Dl" class="btn ghost" download>‚¨áÔ∏è Yuklab olish</a><canvas id="p2Wave" height="46" aria-hidden="true"></canvas></div>
            <div class="crit" id="p2Crit"></div>
          </div>
        </div>

        <!-- P3 -->
        <div class="section" id="p3" aria-hidden="true" style="display:none">
          <div class="head row">
            <strong>Part 3 ‚Äî Discussion</strong>
            <span class="pill" id="p3Score">‚Äî</span>
            <div class="spacer"></div>
            <button class="btn" data-rec="p3">‚è∫Ô∏è P3 Start/Stop</button>
          </div>
          <div class="body">
            <div class="qa" id="p3Qs">Savollar...</div>
            <div class="audio-row"><audio id="p3Audio" controls></audio><a id="p3Dl" class="btn ghost" download>‚¨áÔ∏è Yuklab olish</a><canvas id="p3Wave" height="46" aria-hidden="true"></canvas></div>
            <div class="crit" id="p3Crit"></div>
          </div>
        </div>
      </section>

      <aside class="card" id="resultsPanel">
        <h2>Natijalar & Eksport</h2>
        <p class="muted">Avtomatik baholash ‚Äî faqat amaliy qo‚Äòllanma sifatida qarang.</p>

        <div class="section">
          <div class="head"><strong>Baholar</strong></div>
          <div class="body">
            <div class="row" style="justify-content:space-between"><div>Part 1:</div><div class="pill" id="r_p1">‚Äî</div></div>
            <div class="row" style="justify-content:space-between;margin-top:10px"><div>Part 2:</div><div class="pill" id="r_p2">‚Äî</div></div>
            <div class="row" style="justify-content:space-between;margin-top:10px"><div>Part 3:</div><div class="pill" id="r_p3">‚Äî</div></div>
            <div style="margin-top:16px" class="row"><div>Overall Speaking Avg:</div><div class="score-pill" id="avgOverall">‚Äî</div></div>
            <div class="small" style="margin-top:12px">Mezonlar: Fluency / Lexical / Grammar / Pronunciation</div>

            <div style="margin-top:18px" class="row">
              <button id="btnExportSession" class="btn">üßæ Seans JSON</button>
              <button id="btnExportAll" class="btn">üì¶ Hammasini ZIP</button>
              <button id="btnExportPNG" class="btn ghost">üñºÔ∏è Export Result PNG</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <!-- external libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    /***********************
     * Utilities & State
     ***********************/
    const el = id => document.getElementById(id);
    const parts = ['p1','p2','p3'];
    const state = {
      stream: null,
      recorder: null,
      chunks: [],
      files: {p1:null,p2:null,p3:null},
      currentPart: 'p1',
      audioCtx: null,
      analyser: null,
      dataArray: null,
      recognition: null,
      transcripts: {p1:'', p2:'', p3:''},
      scores: {p1:null,p2:null,p3:null},
      session: {}
    };
    const pad = n => String(n).padStart(2,'0');
    const fmt = s => `${pad(Math.floor(s/60))}:${pad(Math.floor(s%60))}`;

    /***********************
     * Theme handling
     ***********************/
    const root = document.documentElement;
    const btnTheme = el('btnTheme');
    function applyTheme(theme){
      root.setAttribute('data-theme', theme);
      localStorage.setItem('pref-theme', theme);
      btnTheme.textContent = theme === 'light' ? 'üåû Light' : 'üåô Dark';
    }
    (function initTheme(){
      const saved = localStorage.getItem('pref-theme');
      applyTheme(saved || 'dark');
    })();
    btnTheme.addEventListener('click', ()=> {
      const cur = root.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      applyTheme(next);
      parts.forEach(p => { if(state.files[p]) drawRecordedWave(state.files[p], p); });
    });

    // print button
    el('btnPrint').addEventListener('click', () => window.print());

    /***********************
     * Show/hide parts (tabs)
     ***********************/
    const tabButtons = document.querySelectorAll('.tab-btn');
    function showPart(part){
      parts.forEach(p=>{
        const node = el(p);
        if(!node) return;
        if(p === part){
          node.style.display = 'block';
          node.setAttribute('aria-hidden','false');
        } else {
          node.style.display = 'none';
          node.setAttribute('aria-hidden','true');
        }
      });
      tabButtons.forEach(btn=>{
        const t = btn.getAttribute('data-target');
        if(t === part){ btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
        else { btn.classList.remove('active'); btn.setAttribute('aria-selected','false'); }
      });
      state.currentPart = part;
    }
    tabButtons.forEach(btn=>{
      btn.addEventListener('click', ()=> {
        const tgt = btn.getAttribute('data-target');
        showPart(tgt);
      });
    });
    showPart(state.currentPart || 'p1');

    /***********************
     * Mic & Visualiser
     ***********************/
    async function setupMic(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        state.stream = stream;
        el('micStatus').textContent = 'Mic: OK';
        state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const src = state.audioCtx.createMediaStreamSource(stream);
        state.analyser = state.audioCtx.createAnalyser();
        state.analyser.fftSize = 512;
        src.connect(state.analyser);
        state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
        drawLive();
        initSpeechRecognition();
      }catch(e){
        console.error(e);
        alert('Mikrofon ruxsat etilmadi. Brauzer sozlamalarini tekshiring.');
        el('micStatus').textContent = 'Mic: blocked';
      }
    }

    let liveAnim = null;
    function drawLive(){
      const c = el('liveWave');
      const ctx = c.getContext('2d');
      const w = c.width = c.clientWidth;
      const h = c.height = c.clientHeight;
      if(!state.analyser){ ctx.clearRect(0,0,w,h); return; }
      state.analyser.getByteTimeDomainData(state.dataArray);
      ctx.clearRect(0,0,w,h);
      ctx.lineWidth = 2;
      ctx.strokeStyle = getComputedStyle(document.body).color;
      ctx.beginPath();
      const slice = w / state.dataArray.length;
      let maxAmp = 0;
      for(let i=0;i<state.dataArray.length;i++){
        const x = i*slice;
        const v = (state.dataArray[i]-128)/128;
        const y = h/2 + v*(h/2.2);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        if(Math.abs(v) > maxAmp) maxAmp = Math.abs(v);
      }
      ctx.stroke();
      // level bar
      const lvl = Math.min(1, maxAmp*1.6);
      el('levelBar').style.width = (lvl*100).toFixed(1) + '%';
      liveAnim = requestAnimationFrame(drawLive);
    }

    /***********************
     * Recorder & SpeechRecognition
     ***********************/
    function createRecorder(){
      if(!state.stream) throw new Error('No stream');
      const opts = { mimeType: 'audio/webm' };
      const rec = new MediaRecorder(state.stream, MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? {mimeType:'audio/webm;codecs=opus'} : opts);
      rec.ondataavailable = e => { if(e.data && e.data.size>0) state.chunks.push(e.data); };
      return rec;
    }

    function startRecording(part){
      if(!state.stream){ alert('Avval Mic test bosing'); return false; }
      if(state.recorder && state.recorder.state === 'recording'){ console.warn('Already recording'); return false; }
      state.chunks = [];
      state.recorder = createRecorder();
      state.recorder.start();
      el('recStatus').textContent = 'Rec: recording';
      if(state.recognition){ state.recognition.lang = 'en-US'; try{ state.recognition.start(); }catch(e){} }
      return true;
    }

    function stopRecording(part){
      return new Promise(resolve=>{
        if(!state.recorder) return resolve(null);
        const rec = state.recorder;
        if(rec.state !== 'recording') return resolve(null);
        rec.onstop = async () => {
          el('recStatus').textContent = 'Rec: saved';
          const blob = new Blob(state.chunks, { type: 'audio/webm' });
          state.files[part] = blob;
          const url = URL.createObjectURL(blob);
          const audioEl = el(part + 'Audio'); if(audioEl){ audioEl.src = url; audioEl.load(); }
          const dl = el(part + 'Dl'); if(dl){ dl.href = url; dl.download = `${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}_${part}.webm`; }
          if(state.recognition){ try{ state.recognition.stop(); }catch(e){} }
          try{ await analyzeBlobAndScore(blob, part); }catch(e){ console.error('Analyze error', e); }
          try{ await drawRecordedWave(blob, part); }catch(e){ console.warn('draw wave fail', e); }
          state.recorder = null;
          resolve(blob);
        };
        try{ rec.stop(); }catch(e){ console.error(e); resolve(null); }
      });
    }

    function initSpeechRecognition(){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){ el('srStatus').textContent = 'unsupported'; return; }
      el('srStatus').textContent = 'available';
      const recog = new SpeechRecognition();
      recog.interimResults = true;
      recog.continuous = true;
      recog.lang = 'en-US';
      recog.onresult = (ev) => {
        let final = '';
        for(let i=0;i<ev.results.length;i++){
          const res = ev.results[i];
          if(res.isFinal) final += res[0].transcript + ' ';
        }
        const p = state.currentPart || 'p1';
        if(final.trim()) state.transcripts[p] = (state.transcripts[p] + ' ' + final).trim();
      };
      recog.onerror = (e)=>{ console.warn('SR error', e); };
      state.recognition = recog;
    }

    /***********************
     * Analysis helpers
     ***********************/
    async function decodeAudio(blob){
      const arrayBuf = await blob.arrayBuffer();
      const aCtx = state.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
      return await aCtx.decodeAudioData(arrayBuf);
    }
    function rms(buf){ let sum=0; for(let i=0;i<buf.length;i++){ const v=buf[i]; sum += v*v; } return Math.sqrt(sum / buf.length); }

    function detectSilences(samples, sr, thresh = 0.02, minSilenceLen = 0.5){
      const windowMs = 50;
      const winSize = Math.floor(sr * windowMs/1000);
      let totalSilence = 0;
      let longPauses = 0;
      let curSil = 0;
      for(let i=0;i<samples.length;i+=winSize){
        let max = 0;
        for(let j=i;j<Math.min(i+winSize, samples.length); j++){ max = Math.max(max, Math.abs(samples[j])); }
        if(max < thresh){ curSil += winSize/sr; } else { if(curSil >= minSilenceLen) longPauses++; totalSilence += curSil; curSil = 0; }
      }
      if(curSil > 0){ if(curSil >= minSilenceLen) longPauses++; totalSilence += curSil; }
      return { totalSilence, longPauses };
    }

    function voicednessRatio(samples, sr){
      const frameSize = 2048;
      const hop = 1024;
      let voicedFrames = 0, total = 0;
      for(let i=0;i+frameSize < samples.length;i+=hop){
        total++;
        const frame = samples.subarray(i, i+frameSize);
        let m=0; for(let k=0;k<frame.length;k++) m+=frame[k]; m/=frame.length;
        for(let k=0;k<frame.length;k++) frame[k]-=m;
        let maxCorr = 0;
        const minF = 60, maxF = 400;
        const minLag = Math.floor(sr / maxF);
        const maxLag = Math.floor(sr / minF);
        let norm = 0;
        for(let lag=minLag; lag<=maxLag; lag++){
          let s=0;
          for(let j=0;j<frame.length-lag;j++) s += frame[j]*frame[j+lag];
          if(s > maxCorr) maxCorr = s;
        }
        for(let j=0;j<frame.length;j++) norm += frame[j]*frame[j];
        const ratio = norm > 0 ? maxCorr / norm : 0;
        if(ratio > 0.25) voicedFrames++;
      }
      return total ? (voicedFrames / total) : 0;
    }

    function tokenize(text){
      if(!text) return [];
      return text.toLowerCase().replace(/[^\w'\s]/g,' ').split(/\s+/).filter(Boolean);
    }
    function lexicalMetrics(words){
      if(words.length===0) return {TTR:0, vocab:0};
      const set = new Set(words);
      return { TTR: set.size / words.length, vocab: set.size };
    }
    const fillerList = ['um','uh','like','you know','i mean','so','actually','basically','right','well'];
    function countFillers(words){
      let cnt=0;
      for(let i=0;i<words.length;i++){
        if(fillerList.includes(words[i])) cnt++;
      }
      return cnt;
    }

    const to9 = v => Math.max(0, Math.min(9, +(v*9).toFixed(1)));

    /***********************
     * Scoring model
     ***********************/
    async function analyzeBlobAndScore(blob, part){
      const audioBuf = await decodeAudio(blob);
      const data = audioBuf.getChannelData(0);
      const sr = audioBuf.sampleRate;
      const duration = audioBuf.duration;
      const energy = rms(data);
      const sil = detectSilences(data, sr, 0.02, 0.6);
      const silenceRatio = duration > 0 ? sil.totalSilence / duration : 0;
      let voicedRatio = 0;
      try{ voicedRatio = voicednessRatio(data, sr); }catch(e){ console.warn('voicedness failed', e); }
      const transcript = (state.transcripts[part] || '').trim();
      const words = tokenize(transcript);
      const wordCount = words.length;
      const speechRate = duration>0 ? (wordCount / duration) : 0; // words/sec
      const lex = lexicalMetrics(words);
      const fillerCount = countFillers(words);
      const sentenceCount = Math.max(1, (transcript.match(/[.!?]/g)||[]).length || 1);
      const avgWordsPerSentence = wordCount / sentenceCount;

      // Fluency
      const silenceFactor = Math.max(0, 1 - silenceRatio*1.6);
      const pausePenalty = Math.max(0, 1 - Math.min(5, sil.longPauses)/5);
      const rateNorm = Math.max(0, Math.min(1, (speechRate - 1.5) / 3.0));
      const fluencyScore = to9( (silenceFactor*0.6 + pausePenalty*0.2 + rateNorm*0.2) );

      // Lexical
      const ttr = lex.TTR; const vocab = lex.vocab;
      const vocabNorm = Math.min(1, Math.log10(Math.max(1,vocab)) / 1.6);
      const lexicalScore = to9( Math.max(0, Math.min(1, ttr*0.6 + vocabNorm*0.4)) );

      // Grammar
      const awps = avgWordsPerSentence; const awpsScore = Math.max(0, Math.min(1, (awps/12)));
      const fillerPenalty = Math.max(0, 1 - Math.min(wordCount, fillerCount) / Math.max(1, wordCount) * 2);
      const grammarScore = to9( Math.max(0, awpsScore*0.8 + fillerPenalty*0.2) );

      // Pronunciation
      const energyNorm = Math.min(1, energy / 0.1);
      const pronScore = to9( Math.max(0, voicedRatio*0.7 + energyNorm*0.3) );

      const final = +(( (fluencyScore + lexicalScore + grammarScore + pronScore) / 4 ).toFixed(1));

      state.scores[part] = {
        fluency: fluencyScore,
        lexical: lexicalScore,
        grammar: grammarScore,
        pronunciation: pronScore,
        final
      };

      const critEl = el(part + 'Crit');
      if(critEl){
        critEl.innerHTML = `
          <strong>Transcript:</strong> ${transcript ? ('<em>'+transcript+'</em>') : '<em>(no transcript)</em>'}
          <br>
          <span class="small">dur: ${duration.toFixed(1)}s ¬∑ words: ${wordCount} ¬∑ silence: ${(silenceRatio*100).toFixed(1)}% ¬∑ long pauses: ${sil.longPauses} ¬∑ voiced: ${(voicedRatio*100).toFixed(0)}%</span>
        `;
      }

      el(part + 'Score').textContent = final.toFixed(1);
      el('r_' + part).textContent = final.toFixed(1);
      computeOverallAndDisplay();
    }

    function computeOverallAndDisplay(){
      const vals = [];
      ['p1','p2','p3'].forEach(p=>{
        const s = state.scores[p];
        if(s && typeof s.final === 'number') vals.push(s.final);
      });
      const overall = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : null;
      el('avgOverall').textContent = overall ? overall.toFixed(1) : '‚Äî';
      if(overall) state.session.overall = overall;
    }

    /***********************
     * draw recorded wave
     ***********************/
    async function drawRecordedWave(blob, part){
      try{
        const ctx = el(part + 'Wave').getContext('2d');
        const arrayBuf = await blob.arrayBuffer();
        const aCtx = state.audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const audioBuf = await aCtx.decodeAudioData(arrayBuf);
        const data = audioBuf.getChannelData(0);
        const len = 800;
        const step = Math.max(1, Math.floor(data.length / len));
        const w = ctx.canvas.width = ctx.canvas.clientWidth;
        const h = ctx.canvas.height = ctx.canvas.clientHeight;
        const amp = h/2 - 2;
        ctx.clearRect(0,0,w,h);
        ctx.lineWidth = 2;
        ctx.strokeStyle = getComputedStyle(document.body).color;
        ctx.beginPath();
        for(let i=0;i<len;i++){
          let min=1,max=-1;
          for(let j=0;j<step;j++){
            const idx = i*step + j;
            if(idx >= data.length) break;
            const v = data[idx];
            if(v < min) min = v;
            if(v > max) max = v;
          }
          const x = i * (w/len);
          ctx.moveTo(x, (1 + min) * amp);
          ctx.lineTo(x, (1 + max) * amp);
        }
        ctx.stroke();
      }catch(e){ console.warn('drawRecordedWave err', e); }
    }

    /***********************
     * Buttons & flow
     ***********************/
    el('btnSetup').addEventListener('click', setupMic);

    // Start / Stop global timer + record for current part
    let globalInterval=null, globalStart=0;
    function startGlobal(){
      globalStart = Date.now();
      state.session.startedAt = new Date().toISOString();
      clearInterval(globalInterval);
      globalInterval = setInterval(()=> {
        const s = Math.floor((Date.now() - globalStart)/1000);
        el('globalTimer').textContent = fmt(s);
      },1000);
    }
    function stopGlobal(){
      clearInterval(globalInterval);
      state.session.finishedAt = new Date().toISOString();
    }

    el('btnStart').addEventListener('click', ()=>{
      if(!state.stream){
        if(!confirm('Mikrofon ruxsatisiz davom etilsinmi? (avval Mic test bosing)')) return;
      }
      startGlobal();
      el('phasePill').textContent = 'Recording';
      el('btnStart').disabled = true;
      el('btnStop').disabled = false;
      state.currentPart = state.currentPart || 'p1';
      startRecording(state.currentPart);
    });

    el('btnStop').addEventListener('click', async ()=>{
      if(state.recorder && state.recorder.state === 'recording'){
        const part = state.currentPart || 'p1';
        await stopRecording(part);
      }
      stopGlobal();
      el('phasePill').textContent = 'Stopped';
      el('btnStart').disabled = false;
      el('btnStop').disabled = true;
      alert('Yozuv to‚Äòxtatildi va baholash bajarildi (agar audio bo‚Äòlsa).');
    });

    // per-part toggle buttons
    document.querySelectorAll('[data-rec]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const part = btn.getAttribute('data-rec');
        if(state.recorder && state.recorder.state === 'recording'){
          if(state.currentPart === part){
            await stopRecording(part);
            return;
          } else {
            await stopRecording(state.currentPart);
            state.currentPart = part;
            startRecording(part);
            return;
          }
        } else {
          state.currentPart = part;
          startRecording(part);
          if(!globalInterval){ startGlobal(); el('btnStart').disabled = true; el('btnStop').disabled = false; }
        }
      });
    });

    el('btnReset').addEventListener('click', ()=>{
      if(!confirm('Butun sessiyani reset qilinsinmi?')) return;
      if(state.recorder && state.recorder.state === 'recording'){ try{ state.recorder.stop(); }catch(e){} }
      stopGlobal();
      parts.forEach(p=>{
        state.files[p]=null;
        state.transcripts[p]='';
        state.scores[p]=null;
        const a = el(p+'Audio'); if(a) a.src='';
        el(p+'Score').textContent = '‚Äî';
        el('r_'+p).textContent = '‚Äî';
        const crit = el(p+'Crit'); if(crit) crit.innerHTML='';
        const c = el(p+'Wave'); if(c) c.getContext('2d').clearRect(0,0,c.width,c.height);
      });
      el('globalTimer').textContent = '00:00';
      el('phasePill').textContent = 'Standby';
      el('btnStart').disabled = false;
      el('btnStop').disabled = true;
      el('avgOverall').textContent = '‚Äî';
      state.session = {};
    });

    /***********************
     * Exports
     ***********************/
    el('btnExportSession').addEventListener('click', ()=>{
      state.session.transcripts = state.transcripts; state.session.scores = state.scores;
      const blob = new Blob([JSON.stringify(state.session,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `speaking_session_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
    });

    el('btnExportAll').addEventListener('click', async ()=>{
      const zip = new JSZip();
      zip.file('session.json', JSON.stringify(state.session,null,2));
      for(const p of parts){
        if(state.files[p]) zip.file(`${p}.webm`, state.files[p]);
      }
      const blob = await zip.generateAsync({type:'blob'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download = `speaking_${new Date().toISOString().slice(0,10)}.zip`; a.click(); URL.revokeObjectURL(url);
    });

    el('btnExportPNG').addEventListener('click', async ()=>{
      try{
        const node = el('resultsPanel');
        el('btnExportPNG').textContent = 'üîÑ Generating...';
        const canvas = await html2canvas(node, {scale:2, useCORS:true, backgroundColor: getComputedStyle(document.body).backgroundColor});
        canvas.toBlob((blob)=>{
          const url = URL.createObjectURL(blob);
          const a=document.createElement('a'); a.href=url; a.download = `speaking_results_${new Date().toISOString().slice(0,10)}.png`; a.click(); URL.revokeObjectURL(url);
          el('btnExportPNG').textContent = 'üñºÔ∏è Export Result PNG';
        }, 'image/png');
      }catch(e){ alert('PNG yaratishda xato: ' + e); el('btnExportPNG').textContent = 'üñºÔ∏è Export Result PNG'; }
    });

    /***********************
     * Hotkeys: Space
     ***********************/
    window.addEventListener('keydown', async (e)=>{
      if(e.code === 'Space' && (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA')){
        e.preventDefault();
        if(state.recorder && state.recorder.state === 'recording'){
          const part = state.currentPart || 'p1';
          await stopRecording(part);
        } else {
          const part = state.currentPart || 'p1';
          startRecording(part);
          if(!globalInterval) startGlobal();
          el('btnStart').disabled = true; el('btnStop').disabled = false;
        }
      }
    });

    /***********************
     * Init UI content
     ***********************/
    function genQuestions(){
      el('p1Qs').innerHTML = '<div class="question">What do you do in your free time?</div><div class="question">Do you prefer mornings or evenings?</div>';
      el('p2Card').textContent = 'Describe a memorable journey you had. You should say: where you went, how you traveled, and explain why it was memorable.';
      el('p3Qs').innerHTML = '<div class="question">How has technology changed communication?</div><div class="question">What makes a city livable?</div>';
    }
    genQuestions();
    el('srStatus').textContent = (window.SpeechRecognition || window.webkitSpeechRecognition) ? 'available' : 'unsupported';

    /***********************
     * Redraw waves on theme change
     ***********************/
    const observer = new MutationObserver(()=> {
      parts.forEach(p=>{
        const file = state.files[p];
        if(file) drawRecordedWave(file, p);
      });
    });
    observer.observe(root, { attributes: true, attributeFilter: ['data-theme'] });
  </script>
</body>
</html>






