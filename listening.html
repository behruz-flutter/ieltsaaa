<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Listening Test — Full</title>
  <style>
    :root{
      --bg:#f7fbff; --card:#fff; --accent:#0b6cff; --accent2:#07b39b; --muted:#6b7280; --danger:#e11d48;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#eef7ff,#ffffff);margin:18px;color:#071232}
    .container{max-width:1100px;margin:0 auto}
    .card{background:var(--card);padding:20px;border-radius:var(--radius);box-shadow:0 12px 36px rgba(11,18,40,0.06)}
    h1{margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}
    .top{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700;transition:transform .12s}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid rgba(11,108,255,0.08)}
    .btn.warn{background:var(--danger)}
    .meter{flex:1;height:12px;background:#eef6ff;border-radius:999px;overflow:hidden}
    .level{height:100%;width:0%;background:linear-gradient(90deg,#34d399,#10b981)}
    .small{font-size:13px;color:var(--muted)}
    .panel{margin-top:16px}
    .card-inner{padding:16px;border-radius:10px;background:linear-gradient(180deg,#fff,#fcfeff);border:1px solid #eef6ff}
    .nav{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:#fff;border:1px solid rgba(11,108,255,0.06);cursor:pointer}
    .pill.active{background:linear-gradient(90deg,var(--accent),#0a5be6);color:#fff;transform:translateY(-3px)}
    .question-box{margin-top:12px;padding:12px;border-radius:10px;border:1px solid #eef6ff;background:#fff}
    .q-title{font-weight:700}
    .controls{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .progress{height:10px;background:#f3f6fb;border-radius:999px;overflow:hidden;margin-top:10px}
    .progress .bar{height:100%;width:0%;background:linear-gradient(90deg,#ffb84d,#ff8a00);transition:width .12s linear}
    .transcript{margin-top:12px;padding:12px;border-radius:10px;border:1px solid #eef6ff;background:linear-gradient(180deg,#fff,#fcfeff)}
    .question-nav{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .animate-pulse{animation:pulse 1200ms infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
    .wave{margin-top:12px;border-radius:10px;border:1px solid rgba(11,108,255,0.04);padding:8px;background:linear-gradient(180deg,#f8fbff,#fff)}
    canvas#wave{width:100%;height:80px;display:block}
    .choices{margin-top:10px}
    .choice{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .checkbox, .radio {width:18px;height:18px}
    .select{padding:8px;border-radius:8px}
    .footer{margin-top:16px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    @media (max-width:900px){ .top{flex-direction:column;align-items:stretch} .nav{justify-content:center} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Listening Test — Full</h1>
      <div class="subtitle"></div>

      <div class="top">
        <button id="playPass" class="btn">Play Passage</button>
        <button id="replayPass" class="btn ghost">Replay</button>
        <button id="startAuto" class="btn ghost">Start Auto Test</button>
        <button id="exportCSV" class="btn ghost">Export CSV</button>
        <div style="display:flex;align-items:center;gap:8px;flex:1">
          <div class="small">Mic level (test)</div>
          <div class="meter" aria-hidden="true"><div id="liveLevel" class="level"></div></div>
        </div>
        <div id="scoreBox" style="text-align:right">
          <div class="small">Progress</div>
          <div id="progressCount" style="font-weight:800">0 / 40</div>
        </div>
      </div>

      <div class="panel">
        <div class="card-inner">
          <div class="nav">
            <div class="pill active" data-part="part1">Part 1</div>
            <div class="pill" data-part="part2">Part 2</div>
            <div class="pill" data-part="part3">Part 3</div>
            <div class="pill" data-part="part4">Part 4</div>
          </div>

          <div id="contentArea"></div>

          <div class="footer">
            <div class="small muted"></div>
            <div>
              <button id="prevQ" class="btn ghost">◀ Prev</button>
              <button id="nextQ" class="btn">Next ▶</button>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

<script>
/* Listening app with Dashboard sync (localStorage key: speaking_listening_questions_v1)
   - Uses SpeechSynthesis for audio playback (SpeechSynthesisUtterance)
   - 4 parts, each with 10 questions (dashboard populates). If key missing, sample data used.
   - Questions shown sequentially (single question view). Answer types: radio, multi (checkbox), opinion (list of bullets with checkboxes), select (dropdown).
   - Auto test: will play passage and start timer (optional).
   - Export CSV of answers.
*/

/* Keys & client id */
const QUESTIONS_KEY = 'speaking_listening_questions_v1';
let CLIENT_ID = sessionStorage.getItem('listening_client');
if(!CLIENT_ID){ CLIENT_ID = Math.random().toString(36).slice(2)+Date.now().toString(36); sessionStorage.setItem('listening_client', CLIENT_ID); }

/* default/sample (matches dashboard sample) */
let DATA = null;
const DEFAULT = {
  part1: { passage: "This is Part 1 sample passage. Listen and answer short multiple choice questions. The lighthouse was built in the 1800s and had several unique features mentioned by the speaker.", questions: [] },
  part2: { passage: "Part 2 passage. This one is longer and composed of dialogues and opinions. Two speakers discuss opinions about a play and aspects of the production including set, lighting, costume and music.", questions: [] },
  part3: { passage: "Boat trip round Tasmania: The passage describes logistics, number of people allowed, boat colours, lunchbox options and litter rules.", questions: [] },
  part4: { passage: "Part 4 — extended lecture style passage. This contains facts, dates, and comparisons. Use it to answer detail questions and map-matching tasks.", questions: [] }
};

/* load from storage or set sample */
function loadData(){
  try{
    const raw = localStorage.getItem(QUESTIONS_KEY);
    if(!raw){ DATA = JSON.parse(JSON.stringify(DEFAULT)); seedSampleQuestions(); return; }
    DATA = JSON.parse(raw);
    // ensure structure
    ['part1','part2','part3','part4'].forEach(k=>{ if(!DATA[k]) DATA[k] = JSON.parse(JSON.stringify(DEFAULT[k])); if(!DATA[k].questions) DATA[k].questions = []; });
    // if no questions, seed samples
    if(DATA.part1.questions.length === 0) seedSampleQuestions();
  }catch(e){ console.warn(e); DATA = JSON.parse(JSON.stringify(DEFAULT)); seedSampleQuestions(); }
}

/* small sample seeding to ensure 10 Q each if absent */
function seedSampleQuestions(){
  // if dashboard created data, don't override. If empty create sample mix
  if(!DATA.part1.questions || DATA.part1.questions.length===0){
    DATA.part1.questions = [
      {type:'multi', text:'Which TWO features of the lighthouse does Lou mention?', choices:['why it was built','who built it','how long it took to build','who staffed it','what it was built with'], answer:[]},
      {type:'radio', text:'What colour is the lighthouse?', choices:['red','white','green'], answer:null},
      {type:'radio', text:'Is the lighthouse open to visitors?', choices:['Yes','No','Some days'], answer:null},
      {type:'radio', text:'What is the keeper\'s name mentioned?', choices:['John','Lou','Marry'], answer:null},
      {type:'radio', text:'How often is the light maintained?', choices:['daily','monthly','yearly'], answer:null},
      {type:'radio', text:'What material used was dominant?', choices:['stone','wood','metal'], answer:null},
      {type:'radio', text:'Which view is highlighted?', choices:['sea view','garden view','mountain view'], answer:null},
      {type:'radio', text:'Who repaired the lantern?', choices:['crew','volunteers','government'], answer:null},
      {type:'radio', text:'When was it restored?', choices:['1990s','2000s','2010s'], answer:null},
      {type:'radio', text:'What was the original fuel?', choices:['oil','electricity','gas'], answer:null}
    ];
  }
  if(!DATA.part2.questions || DATA.part2.questions.length===0){
    DATA.part2.questions = [
      {type:'opinion', text:'Opinions', choices:['They both expected this to be more traditional.','They both thought this was original.','They agree this created the right atmosphere.','They agree this was a major strength.','They were both disappointed by this.','They disagree about why this was an issue.','They disagree about how this could be improved.'], answer:[]},
      {type:'select', text:'the set', choices:['modern','traditional','minimal'], answer:null},
      {type:'select', text:'the lighting', choices:['atmospheric','poor','dazzling'], answer:null},
      {type:'select', text:'the costume design', choices:['creative','boring','accurate'], answer:null},
      {type:'select', text:'the music', choices:['supportive','distracting','absent'], answer:null},
      {type:'select', text:'the actors delivery', choices:['convincing','flat','overacted'], answer:null},
      {type:'radio', text:'Did they like the play overall?', choices:['Yes','No','Mixed'], answer:null},
      {type:'radio', text:'Was it longer than expected?', choices:['Yes','No','Shorter'], answer:null},
      {type:'radio', text:'Would they recommend it?', choices:['Yes','No','Maybe'], answer:null},
      {type:'radio', text:'Would they go again?', choices:['Yes','No','Only if invited'], answer:null}
    ];
  }
  if(!DATA.part3.questions || DATA.part3.questions.length===0){
    DATA.part3.questions = [
      {type:'radio', text:'What is the maximum number of people who can stand on each side of the boat?', choices:['9','15','18'], answer:null},
      {type:'radio', text:'What colour are the tour boats?', choices:['dark red','jet black','light green'], answer:null},
      {type:'radio', text:'Which lunchbox is suitable for someone who doesn\'t eat meat or fish?', choices:['Lunchbox1','Lunchbox2','Lunchbox3'], answer:null},
      {type:'radio', text:'What should people do with their litter?', choices:['take it home','hand it to staff','put it in bins'], answer:null},
      {type:'radio', text:'How long is the trip?', choices:['2 hours','3 hours','4 hours'], answer:null},
      {type:'radio', text:'Is safety briefing required?', choices:['Yes','No','Optional'], answer:null},
      {type:'radio', text:'Where do they meet?', choices:['pier A','station','market'], answer:null},
      {type:'radio', text:'What is provided?', choices:['life jackets','blankets','sunglasses'], answer:null},
      {type:'radio', text:'What is the main target audience?', choices:['families','solo travellers','backpackers'], answer:null},
      {type:'radio', text:'Is booking needed?', choices:['Yes','No','Sometimes'], answer:null}
    ];
  }
  if(!DATA.part4.questions || DATA.part4.questions.length===0){
    DATA.part4.questions = [
      {type:'radio', text:'Main topic of lecture?', choices:['History of trade','Maritime technology','Art movement'], answer:null},
      {type:'radio', text:'Which century is emphasized?', choices:['18th','19th','20th'], answer:null},
      {type:'radio', text:'Which country is mentioned most?', choices:['UK','France','Spain'], answer:null},
      {type:'radio', text:'What system was introduced?', choices:['steam','electric','diesel'], answer:null},
      {type:'radio', text:'Primary benefit noted?', choices:['speed','cost','safety'], answer:null},
      {type:'radio', text:'Who funded the project?', choices:['government','private','charity'], answer:null},
      {type:'radio', text:'How was the data collected?', choices:['surveys','archives','fieldwork'], answer:null},
      {type:'radio', text:'Which evidence is most convincing?', choices:['photographs','reports','testimonials'], answer:null},
      {type:'radio', text:'What challenge remains?', choices:['funding','training','infrastructure'], answer:null},
      {type:'radio', text:'Lecture tone is', choices:['critical','neutral','celebratory'], answer:null}
    ];
  }
}

/* UI state: current part and question index */
let currentPart = 'part1';
let qIndex = 0;

/* audio playback using SpeechSynthesis */
function playPassage(part){
  const passage = DATA[part].passage || '';
  if(!passage){ alert('No passage text found.'); return; }
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(passage);
    u.lang = 'en-US';
    // voice selection: try default
    window.speechSynthesis.speak(u);
    u.onend = ()=> { showToast('Passage finished'); };
  } else {
    alert('SpeechSynthesis not supported in this browser.');
  }
}

/* render single question view */
function render(){
  // update nav pills
  document.querySelectorAll('.pill').forEach(p=> p.classList.toggle('active', p.dataset.part === currentPart));
  // ensure qIndex valid
  const count = DATA[currentPart].questions.length;
  if(qIndex < 0) qIndex = 0;
  if(qIndex >= count) qIndex = count - 1;
  const q = DATA[currentPart].questions[qIndex];
  const totalAnswered = countAnswered();
  document.getElementById('progressCount').textContent = `${totalAnswered} / ${totalTotalQuestions()}`;

  // create HTML for question types
  const html = document.createElement('div');
  html.className = 'question-box';
  let inner = '';
  inner += `<div style="display:flex;justify-content:space-between;align-items:center">
    <div><div class="q-title">${escapeHtml(currentPart.toUpperCase())}</div><div class="small">Question ${qIndex+1} / ${count}</div></div>
    <div><button id="playPassBtn" class="btn ghost">Play Passage</button></div>
  </div>`;
  inner += `<div style="margin-top:12px"><strong>${escapeHtml(q.text)}</strong></div>`;

  // choices UI
  inner += `<div class="choices" id="choicesArea"></div>`;
  inner += `<div class="wave" style="display:none"><canvas id="wave"></canvas></div>`;
  inner += `<div class="question-nav"> <button id="answerSkip" class="btn ghost">Skip</button> </div>`;

  html.innerHTML = inner;
  const area = document.getElementById('contentArea');
  area.innerHTML = '';
  area.appendChild(html);

  document.getElementById('playPassBtn').addEventListener('click', ()=> { playPassage(currentPart); animatePlay(); });

  const choicesArea = document.getElementById('choicesArea');

  if(q.type === 'radio'){
    q.choices.forEach((c, i)=>{
      const id = `c_${i}`;
      const div = document.createElement('div'); div.className='choice';
      div.innerHTML = `<input type="radio" name="choice" id="${id}" class="radio"> <label for="${id}">${escapeHtml(c)}</label>`;
      choicesArea.appendChild(div);
      div.querySelector('input').addEventListener('change', ()=>{
        DATA[currentPart].questions[qIndex].answer = c;
        saveProgress();
      });
      // restore selection
      if(q.answer === c) div.querySelector('input').checked = true;
    });
  } else if(q.type === 'multi'){
    q.choices.forEach((c, i)=>{
      const id = `m_${i}`;
      const div = document.createElement('div'); div.className='choice';
      div.innerHTML = `<input type="checkbox" id="${id}" class="checkbox"> <label for="${id}">${escapeHtml(c)}</label>`;
      choicesArea.appendChild(div);
      div.querySelector('input').addEventListener('change', ()=>{
        const arr = DATA[currentPart].questions[qIndex].answer || [];
        if(div.querySelector('input').checked) { arr.push(c); } else { const idx = arr.indexOf(c); if(idx>-1) arr.splice(idx,1); }
        DATA[currentPart].questions[qIndex].answer = arr;
        saveProgress();
      });
      if(Array.isArray(q.answer) && q.answer.indexOf(c) !== -1) div.querySelector('input').checked = true;
    });
  } else if(q.type === 'opinion'){
    // render list of bullet options with checkboxes (like image)
    const box = document.createElement('div'); box.style.border = '1px solid #e6e6e6'; box.style.padding = '10px'; box.style.background='#fafafa';
    const ul = document.createElement('ul');
    ul.style.paddingLeft = '18px';
    q.choices.forEach((c,i)=>{
      const li = document.createElement('li');
      const id = `op_${i}`;
      li.innerHTML = `<input type="checkbox" id="${id}"> <label for="${id}">${escapeHtml(c)}</label>`;
      li.style.marginBottom='8px';
      ul.appendChild(li);
      li.querySelector('input').addEventListener('change', ()=>{
        const arr = DATA[currentPart].questions[qIndex].answer || [];
        if(li.querySelector('input').checked) arr.push(c); else { const idx = arr.indexOf(c); if(idx>-1) arr.splice(idx,1); }
        DATA[currentPart].questions[qIndex].answer = arr;
        saveProgress();
      });
      if(Array.isArray(q.answer) && q.answer.indexOf(c)!==-1) li.querySelector('input').checked = true;
    });
    box.appendChild(ul); choicesArea.appendChild(box);
  } else if(q.type === 'select'){
    // dropdown
    const sel = document.createElement('select'); sel.className='select';
    const defaultOpt = document.createElement('option'); defaultOpt.value=''; defaultOpt.textContent='Select...'; sel.appendChild(defaultOpt);
    q.choices.forEach(c=>{
      const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    });
    if(q.answer) sel.value = q.answer;
    sel.addEventListener('change', ()=> { DATA[currentPart].questions[qIndex].answer = sel.value || null; saveProgress(); });
    choicesArea.appendChild(sel);
  }

  // skip button
  document.getElementById('answerSkip').addEventListener('click', ()=> {
    // leave answer null/empty
    navigate(1);
  });

  // enable prev/next
  document.getElementById('prevQ').onclick = ()=> navigate(-1);
  document.getElementById('nextQ').onclick = ()=> navigate(1);
}

/* navigation */
function navigate(delta){
  // move within same part or jump between parts
  const count = DATA[currentPart].questions.length;
  qIndex += delta;
  if(qIndex < 0){
    // go to previous part
    if(currentPart === 'part1'){ qIndex = 0; } else if(currentPart === 'part2'){ currentPart = 'part1'; qIndex = DATA.part1.questions.length-1; }
    else if(currentPart === 'part3'){ currentPart = 'part2'; qIndex = DATA.part2.questions.length-1; }
    else if(currentPart === 'part4'){ currentPart = 'part3'; qIndex = DATA.part3.questions.length-1; }
  } else if(qIndex >= count){
    // advance to next part
    if(currentPart === 'part1'){ currentPart='part2'; qIndex=0; }
    else if(currentPart === 'part2'){ currentPart='part3'; qIndex=0; }
    else if(currentPart === 'part3'){ currentPart='part4'; qIndex=0; }
    else if(currentPart === 'part4'){ // finished all
      alert('Test tugadi — eksport yoki natijalarni ko‘ring.');
      return;
    }
  }
  render();
}

/* save progress locally (transcripts = answers) */
function saveProgress(){
  try{ localStorage.setItem(QUESTIONS_KEY+'_ANSWERS', JSON.stringify(DATA)); }catch(e){ console.warn(e); }
  updateProgressCount();
}

/* count answered */
function countAnswered(){
  let count=0;
  ['part1','part2','part3','part4'].forEach(k=>{
    (DATA[k].questions || []).forEach(q=>{
      if(q.type==='multi' || q.type==='opinion'){ if(Array.isArray(q.answer) && q.answer.length>0) count++; }
      else { if(q.answer !== null && q.answer !== undefined && q.answer !== '') count++; }
    });
  });
  return count;
}
function totalTotalQuestions(){ return (DATA.part1.questions.length + DATA.part2.questions.length + DATA.part3.questions.length + DATA.part4.questions.length); }
function updateProgressCount(){ document.getElementById('progressCount').textContent = `${countAnswered()} / ${totalTotalQuestions()}`; }

/* export CSV */
function exportCSV(){
  const rows = [];
  rows.push(['part','qIndex','question','type','choices','answer']);
  ['part1','part2','part3','part4'].forEach(part=>{
    DATA[part].questions.forEach((q,i)=>{
      rows.push([part, i+1, q.text.replace(/[\n\r]+/g,' '), q.type, (q.choices||[]).join(' | '), Array.isArray(q.answer)? q.answer.join(' | '): (q.answer||'')]);
    });
  });
  const csv = rows.map(r=> r.map(cell=> `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'listening_answers.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* speech synthesis animation (button) */
function animatePlay(){
  const btn = document.getElementById('playPass');
  btn.classList.add('animate-pulse');
  setTimeout(()=> btn.classList.remove('animate-pulse'), 1500);
}

/* simple toast */
function showToast(msg){
  const el = document.createElement('div'); el.textContent = msg; el.style.position='fixed'; el.style.bottom='18px'; el.style.right='18px';
  el.style.background='#0652ff'; el.style.color='#fff'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.boxShadow='0 10px 30px rgba(6,82,255,0.12)';
  document.body.appendChild(el); setTimeout(()=>{ el.style.transition='opacity .4s'; el.style.opacity='0'; setTimeout(()=>el.remove(),400); }, 1800);
}

/* nav pills click */
document.querySelectorAll('.pill').forEach(p=>{
  p.addEventListener('click', ()=> {
    currentPart = p.dataset.part; qIndex = 0; render();
  });
});

/* Play passage buttons */
document.getElementById('playPass').addEventListener('click', ()=> { playPassage(currentPart); animatePlay(); });
document.getElementById('replayPass').addEventListener('click', ()=> { playPassage(currentPart); });
document.getElementById('exportCSV').addEventListener('click', exportCSV);

/* Auto test: play passage then show first question, with optional per-question timer */
let autoTimer = null;
document.getElementById('startAuto').addEventListener('click', ()=> {
  if(!confirm('Auto Test: Passage will play and you will be moved question-by-question. Tayyor?')) return;
  playPassage(currentPart);
  // after passage ends (approx estimate) — use onend: but speechSynthesis Utterance onend used inside playPassage? we can set timeout approx by word count
  const passage = DATA[currentPart].passage || '';
  const words = passage.split(/\s+/).length || 100;
  const est = Math.max(3000, words*200); // rough 200ms per word
  setTimeout(()=> {
    qIndex = 0; render();
    // optional per-question timer: 30s
    startPerQuestionAuto();
  }, est+500);
});

/* per-question auto progression (30s each) */
function startPerQuestionAuto(){
  if(autoTimer) clearInterval(autoTimer);
  let seconds = 30;
  showToast('Auto mode: each question 30s');
  autoTimer = setInterval(()=> {
    seconds--;
    if(seconds <= 0){
      // move next
      navigate(1);
      seconds = 30;
    }
  }, 1000);
}

/* BroadcastChannel + storage events: when dashboard updates QUESTIONS_KEY, reload DATA */
try{
  const bc = new BroadcastChannel('listening_channel');
  bc.onmessage = (ev)=>{
    const msg = ev.data;
    if(msg && (msg.type === 'questions_updated' || msg.type === 'questions_removed')){
      // reload
      loadData();
      render();
      showToast('Questions updated from Dashboard');
    }
  };
}catch(e){ /* ignore */ }

window.addEventListener('storage', (e)=>{
  if(e.key === QUESTIONS_KEY){
    loadData(); render(); showToast('Questions updated (storage event)');
  }
});

/* init UI and loading */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function totalTotal() { return totalTotalQuestions(); }

loadData();
render();
updateProgressCount();

</script>
</body>
</html>
