<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Writing â€” Tasks (Connected to Dashboard)</title>
  <style>
    :root{
      --bg:#f6f9fc; --card:#fff; --accent:#0b6cff; --accent-2:#0066ff;
      --muted:#6b7280; --success:#16a34a; --danger:#e11d48; --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{margin:18px;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#071023}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(11,24,48,0.06);border:1px solid #e6eef8}
    h1{margin:0 0 6px;font-size:20px}
    .hint{color:var(--muted);font-size:13px;margin-bottom:14px}
    .topbar{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .btn:active{transform:translateY(1px)}
    .btn:focus{outline:3px solid rgba(11,108,255,0.12)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 6px 18px rgba(11,108,255,0.14)}
    .btn.ghost{background:transparent;border:1px solid #e3eefc;color:#0b6cff}
    .btn.warn{background:#ffefeb;color:#7a2700}
    .meter{flex:1;height:12px;background:#eef4fb;border-radius:999px;overflow:hidden}
    .meter > .level{height:100%;width:0%;background:linear-gradient(90deg,#34d399,#10b981);transition:width .12s linear}
    .panel{margin-top:12px}
    .prompt-box{padding:16px;border-radius:12px;background:linear-gradient(180deg,#fbfdff,#fff);border:1px solid #eef7ff;box-shadow:inset 0 -6px 20px rgba(115,153,255,0.02)}
    .prompt-text{font-weight:700;font-size:18px}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    .editor{margin-top:14px}
    textarea.editor-area{width:100%;min-height:260px;padding:14px;border-radius:10px;border:1px solid #e6eef8;font-size:15px;line-height:1.6;resize:vertical;transition:box-shadow .12s ease}
    textarea.editor-area:focus{box-shadow:0 10px 30px rgba(11,108,255,0.08);outline:none}
    .meta-row{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .badge{padding:6px 10px;border-radius:999px;background:#eef6ff;border:1px solid #dbeafe;color:#0b6cff;font-weight:700}
    .small{color:var(--muted);font-size:13px}
    .nav{display:flex;gap:8px;align-items:center;margin-top:12px;justify-content:flex-end}
    .nav .btn{min-width:110px}
    .animated-record{height:8px;background:#f3f3f3;border-radius:999px;overflow:hidden;margin-top:14px}
    .animated-record > .bar{height:100%;width:0%;background:linear-gradient(90deg,#ffb84d,#ff8a00);transition:width .2s linear}
    .success{color:var(--success);font-weight:700}
    .danger{color:var(--danger);font-weight:700}
    .foot{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    /* button hover */
    .btn:hover{transform:translateY(-3px)}
    /* fancy pulse for live save */
    .pulse{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--success);box-shadow:0 0 0 rgba(16,185,129,0.4);animation:ping 1.2s infinite}
    @keyframes ping{0%{transform:scale(1);opacity:1}70%{transform:scale(1.7);opacity:0}100%{opacity:0}}
    /* responsive */
    @media (max-width:720px){ .topbar{flex-direction:column;align-items:stretch} .nav{justify-content:space-between} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="topbar">
        <div style="flex:1">
          <h1>Writing Tasks</h1>
          <div class="hint"></div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="restartBtn" class="btn" title="Clear my saved answers">ðŸ”„ Restart</button>
          <!-- Fullscreen button (non-invasive) -->
          <button id="btnFullscreen" class="btn ghost" title="Toggle fullscreen">â›¶ Fullscreen</button>

          <div style="width:180px">
            <div class="meter" aria-hidden="true"><div id="saveLevel" class="level" style="width:0%"></div></div>
            <div class="small" style="text-align:center;margin-top:6px" id="saveLabel">Autosave idle</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div id="taskWrap" class="prompt-box">
          <!-- prompt content will be injected -->
        </div>

        <div class="editor">
          <textarea id="editor" class="editor-area" placeholder="Type your answer here..."></textarea>
          <div class="meta-row">
            <div class="badge" id="taskBadge">Task 1 / 3</div>
            <div class="small">Words: <span id="wordCount">0</span></div>
            <div class="small">Chars: <span id="charCount">0</span></div>
            <div class="small">Last saved: <span id="lastSaved">â€”</span></div>
            <div style="flex:1"></div>
            <div id="acceptStatus" class="small"></div>
          </div>

          <div class="animated-record" aria-hidden="true"><div id="progressBar" class="bar" style="width:0%"></div></div>

          <div class="nav">
            <div style="display:flex;gap:8px">
              <button id="prevBtn" class="btn ghost">â—€ Prev</button>
              <button id="nextBtn" class="btn ghost">Next â–¶</button>
            </div>
            <div style="display:flex;gap:8px">
              <button id="saveBtn" class="btn primary">ðŸ’¾ Save</button>
              <button id="finishBtn" class="btn">âœ… Finish</button>
            </div>
          </div>
        </div>

        <div class="foot"></div>
      </div>
    </div>
  </div>

<script>
/* writing.html â€” connected to writing-dashboard (localStorage key: writing_prompts_v1) */

/* Keys */
const PROMPTS_KEY = 'writing_prompts_v1';
const APP_KEY = 'writing_app_v1';

/* defaults */
const DEFAULT_PROMPTS = {
  tasks: [
    { title: 'Task 1 â€” Short response', desc: 'Briefly describe your favourite pastime and why you enjoy it.' , minWords: 0 },
    { title: 'Task 2 â€” Essay (200+ words)', desc: 'Write an essay about the benefits and drawbacks of living in a large city. Aim for at least 200 words.', minWords: 200 },
    { title: 'Task 3 â€” Opinion', desc: 'Do you think technology is improving education? Explain with examples.', minWords: 0 }
  ],
  meta: { updatedAt: Date.now() }
};

/* client id (not required but useful) */
let CLIENT_ID = sessionStorage.getItem('writing_client_id');
if(!CLIENT_ID){ CLIENT_ID = Math.random().toString(36).slice(2)+Date.now().toString(36); sessionStorage.setItem('writing_client_id', CLIENT_ID); }

/* load prompts from storage */
function loadPrompts(){
  try{
    const raw = localStorage.getItem(PROMPTS_KEY);
    if(!raw) return JSON.parse(JSON.stringify(DEFAULT_PROMPTS));
    const parsed = JSON.parse(raw);
    parsed.tasks = parsed.tasks && parsed.tasks.length ? parsed.tasks : DEFAULT_PROMPTS.tasks.slice();
    parsed.meta = parsed.meta || { updatedAt: Date.now() };
    return parsed;
  }catch(e){
    console.warn('loadPrompts error', e);
    return JSON.parse(JSON.stringify(DEFAULT_PROMPTS));
  }
}

/* load app state (answers) */
function loadApp(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw){
      return { answers: Array(PROMPTS.tasks.length).fill(''), savedAt: Array(PROMPTS.tasks.length).fill(null) };
    }
    const parsed = JSON.parse(raw);
    // ensure arrays match length
    parsed.answers = parsed.answers || [];
    while(parsed.answers.length < PROMPTS.tasks.length) parsed.answers.push('');
    parsed.answers.length = PROMPTS.tasks.length;
    parsed.savedAt = parsed.savedAt || [];
    while(parsed.savedAt.length < PROMPTS.tasks.length) parsed.savedAt.push(null);
    parsed.savedAt.length = PROMPTS.tasks.length;
    return parsed;
  }catch(e){
    console.warn('loadApp error', e);
    return { answers: Array(PROMPTS.tasks.length).fill(''), savedAt: Array(PROMPTS.tasks.length).fill(null) };
  }
}
function saveApp(state){
  try{
    localStorage.setItem(APP_KEY, JSON.stringify(state));
    return true;
  }catch(e){
    console.warn('saveApp failed', e);
    return false;
  }
}

/* state */
let PROMPTS = loadPrompts();
let APP = loadApp();
let currentIndex = 0;

/* DOM */
const taskWrap = document.getElementById('taskWrap');
const editor = document.getElementById('editor');
const wordCountEl = document.getElementById('wordCount');
const charCountEl = document.getElementById('charCount');
const lastSavedEl = document.getElementById('lastSaved');
const taskBadge = document.getElementById('taskBadge');
const saveBtn = document.getElementById('saveBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const progressBar = document.getElementById('progressBar');
const saveLevel = document.getElementById('saveLevel');
const saveLabel = document.getElementById('saveLabel');
const restartBtn = document.getElementById('restartBtn');
const acceptStatus = document.getElementById('acceptStatus');
const finishBtn = document.getElementById('finishBtn');
const btnFullscreen = document.getElementById('btnFullscreen');

/* render current prompt (single sequential view) */
function renderPrompt(idx){
  PROMPTS = loadPrompts(); // refresh in case changed
  // clamp
  if(idx < 0) idx = 0;
  if(idx >= PROMPTS.tasks.length) idx = PROMPTS.tasks.length - 1;
  currentIndex = idx;
  const t = PROMPTS.tasks[idx];
  taskWrap.innerHTML = `
    <div class="prompt-text">${escapeHtml(t.title)}</div>
    <div style="margin-top:8px" class="small">${escapeHtml(t.desc)}</div>
  `;
  taskBadge.textContent = `Task ${idx+1} / ${PROMPTS.tasks.length}`;
  editor.value = APP.answers[idx] || '';
  updateCounts();
  lastSavedEl.textContent = APP.savedAt && APP.savedAt[idx] ? new Date(APP.savedAt[idx]).toLocaleTimeString() : 'â€”';
  updateNavButtons();
  updateAcceptState();
  animateProgressForIndex(idx);
}

/* update nav */
function updateNavButtons(){
  prevBtn.disabled = currentIndex === 0;
  nextBtn.disabled = currentIndex === PROMPTS.tasks.length -1;
}

/* counts */
function updateCounts(){
  const txt = editor.value || '';
  const words = txt.trim() ? txt.trim().split(/\s+/).filter(w=>w).length : 0;
  wordCountEl.textContent = words;
  charCountEl.textContent = txt.length;
  // progress visual (percent of recommended words for Task 2 etc)
  const min = PROMPTS.tasks[currentIndex].minWords || 0;
  const pct = min > 0 ? Math.min(100, Math.round((words/min)*100)) : 0;
  progressBar.style.width = pct + '%';
}

/* accept state (for tasks with minWords) */
function updateAcceptState(){
  const min = PROMPTS.tasks[currentIndex].minWords || 0;
  const words = (editor.value.trim() ? editor.value.trim().split(/\s+/).filter(w=>w).length : 0);
  if(min > 0){
    if(words >= min){
      acceptStatus.innerHTML = `<span class="success">Meets minimum (${min} words)</span>`;
    } else {
      acceptStatus.innerHTML = `<span class="danger">Requires at least ${min} words â€” not accepted yet</span>`;
    }
  } else acceptStatus.innerHTML = '';
}

/* autosave mechanism */
let autosaveTimer = null;
function scheduleAutosave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  saveLabel.textContent = 'Saving...';
  saveLevel.style.width = '60%';
  autosaveTimer = setTimeout(()=> {
    APP.answers[currentIndex] = editor.value;
    APP.savedAt[currentIndex] = Date.now();
    saveApp(APP);
    saveLabel.textContent = 'Saved';
    saveLevel.style.width = '100%';
    lastSavedEl.textContent = new Date(APP.savedAt[currentIndex]).toLocaleTimeString();
    // small pulse then reset
    setTimeout(()=> { saveLevel.style.width = '0%'; saveLabel.textContent = 'Autosave idle'; }, 800);
  }, 800);
}

/* manual save button (saves whole APP state) */
saveBtn.addEventListener('click', ()=> {
  APP.answers[currentIndex] = editor.value;
  APP.savedAt[currentIndex] = Date.now();
  saveApp(APP);
  saveLabel.textContent = 'Saved (manual)';
  saveLevel.style.width = '100%';
  lastSavedEl.textContent = new Date(APP.savedAt[currentIndex]).toLocaleTimeString();
  setTimeout(()=> { saveLevel.style.width = '0%'; saveLabel.textContent = 'Autosave idle'; }, 900);
});

/* navigation */
prevBtn.addEventListener('click', ()=> {
  saveCurrentThen(()=> renderPrompt(currentIndex - 1));
});
nextBtn.addEventListener('click', ()=> {
  saveCurrentThen(()=> renderPrompt(currentIndex + 1));
});

/* finish: show summary modal (simple) */
finishBtn.addEventListener('click', ()=> {
  // collect stats
  const items = PROMPTS.tasks.map((t,i)=>{
    const txt = APP.answers[i] || '';
    const words = txt.trim() ? txt.trim().split(/\s+/).filter(w=>w).length : 0;
    const savedAt = APP.savedAt[i] ? new Date(APP.savedAt[i]).toLocaleString() : 'â€”';
    return `<div style="margin-bottom:10px"><strong>${escapeHtml(t.title)}</strong> â€” Words: ${words} â€” Saved: ${savedAt}</div>`;
  }).join('');
  alert('Summary:\n\n' + PROMPTS.tasks.map((t,i)=>`${i+1}. ${t.title} â€” ${ (APP.answers[i]||'').trim().split(/\s+/).filter(w=>w).length } words`).join('\n'));
});

/* save current helper */
function saveCurrentThen(cb){
  APP.answers[currentIndex] = editor.value;
  APP.savedAt[currentIndex] = Date.now();
  saveApp(APP);
  saveLabel.textContent = 'Saved';
  saveLevel.style.width = '100%';
  lastSavedEl.textContent = new Date(APP.savedAt[currentIndex]).toLocaleTimeString();
  setTimeout(()=> { saveLevel.style.width = '0%'; saveLabel.textContent = 'Autosave idle'; if(cb) cb(); }, 600);
}

/* editor events */
editor.addEventListener('input', ()=> {
  updateCounts();
  updateAcceptState();
  scheduleAutosave();
});

/* keyboard shortcuts: Ctrl+Enter to save */
editor.addEventListener('keydown', (e)=> {
  if((e.ctrlKey || e.metaKey) && e.key === 'Enter'){
    e.preventDefault();
    saveBtn.click();
  }
});

/* open dashboard */
const openDashboardBtn = document.getElementById('openDashboard');
openDashboardBtn.addEventListener('click', ()=> {
  // try to open dashboard file in same folder name
  const dash = location.origin + location.pathname.replace(/[^/]*$/, '') + 'writing-dashboard.html';
  window.open(dash, '_blank');
});

/* restart: clear APP_KEY for this user */
restartBtn.addEventListener('click', ()=> {
  if(!confirm('Restart: barcha javoblaringiz oÊ»chiriladi. Davom etilsinmi?')) return;
  try{ localStorage.removeItem(APP_KEY); }catch(e){}
  APP = { answers: Array(PROMPTS.tasks.length).fill(''), savedAt: Array(PROMPTS.tasks.length).fill(null) };
  editor.value = '';
  renderPrompt(0);
  alert('Yozganlaringiz oÊ»chirildi.');
});

/* storage event: listen for prompt updates from dashboard */
window.addEventListener('storage', (e)=> {
  if(e.key === PROMPTS_KEY){
    const prevLen = PROMPTS.tasks.length;
    PROMPTS = loadPrompts();
    // if new length differs, adapt APP arrays
    APP = loadApp(); // reload app to align lengths
    // if currentIndex out of range, clamp:
    if(currentIndex >= PROMPTS.tasks.length) currentIndex = PROMPTS.tasks.length - 1;
    renderPrompt(currentIndex);
    // notify
    toast('Prompts updated from Dashboard â€” UI refreshed.');
  } else if (e.key === APP_KEY){
    // another tab updated answers â€” reload
    APP = loadApp();
    renderPrompt(currentIndex);
  }
});

/* small toast util */
function toast(msg){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed'; el.style.right='18px'; el.style.bottom='18px';
  el.style.background='rgba(11,108,255,0.96)'; el.style.color='white'; el.style.padding='10px 12px';
  el.style.borderRadius='8px'; el.style.boxShadow='0 8px 24px rgba(11,24,48,0.18)';
  el.style.zIndex=99999; el.style.fontSize='13px';
  document.body.appendChild(el);
  setTimeout(()=> el.style.opacity='0.0', 2200);
  setTimeout(()=> el.remove(), 2600);
}

/* helper to animate index progress bar subtly */
function animateProgressForIndex(idx){
  const p = Math.round(((idx+1)/PROMPTS.tasks.length)*100);
  saveLevel.style.width = p + '%';
  saveLabel.textContent = `Task ${idx+1} / ${PROMPTS.tasks.length}`;
  setTimeout(()=> { saveLevel.style.width = '0%'; saveLabel.textContent = 'Autosave idle'; }, 700);
}

/* initial load */
PROMPTS = loadPrompts();
APP = loadApp();
renderPrompt(0);

/* small helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ensure we save before unload */
window.addEventListener('beforeunload', ()=> {
  APP.answers[currentIndex] = editor.value;
  APP.savedAt[currentIndex] = Date.now();
  saveApp(APP);
});

/* ------------------ FULLSCREEN: small, non-invasive addition ------------------
   Adds a fullscreen toggle button that makes the .card element fullscreen.
   It does not change other functionality.
*/
(function setupFullscreen(){
  const btn = btnFullscreen;
  if(!btn) return;
  function isFull(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
  }
  async function requestFull(el){
    if(el.requestFullscreen) return el.requestFullscreen();
    if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
    if(el.mozRequestFullScreen) return el.mozRequestFullScreen();
    if(el.msRequestFullscreen) return el.msRequestFullscreen();
  }
  async function exitFull(){
    if(document.exitFullscreen) return document.exitFullscreen();
    if(document.webkitExitFullscreen) return document.webkitExitFullscreen();
    if(document.mozCancelFullScreen) return document.mozCancelFullScreen();
    if(document.msExitFullscreen) return document.msExitFullscreen();
  }
  btn.addEventListener('click', async ()=>{
    try{
      if(!isFull()){
        const card = document.querySelector('.card') || document.documentElement;
        await requestFull(card);
      } else {
        await exitFull();
      }
    }catch(e){
      console.warn('Fullscreen error', e);
    }
  });
  function updateLabel(){
    if(isFull()){ btn.textContent = 'â¤« Exit Fullscreen'; btn.classList.add('primary'); }
    else { btn.textContent = 'â›¶ Fullscreen'; btn.classList.remove('primary'); }
  }
  document.addEventListener('fullscreenchange', updateLabel);
  document.addEventListener('webkitfullscreenchange', updateLabel);
  document.addEventListener('mozfullscreenchange', updateLabel);
  document.addEventListener('MSFullscreenChange', updateLabel);
  updateLabel();
})();
</script>
</body>
</html>
